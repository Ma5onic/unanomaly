<!DOCTYPE html>
<html>
	<head>
		<link rel=stylesheet href="styles/index.css" type="text/css">
		<script type="text/javascript" src="scripts/jquery-1.8.3.js"></script>	
		<script src="http://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
		<link rel="stylesheet" href="http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css" />
		<script src="scripts/js/highcharts.js" type="text/javascript"></script>
		<script>
			$(document).ready(function(){
				
				var pathFile = "";
				var file;
				var chart;
				var outLiers;
				var dataLocalFile;
				var listaColumna = [];

				$( "#slider" ).slider();

				var oFReader = new FileReader();
 
				oFReader.onload = function (oFREvent) {
					dataLocalFile = oFREvent.target.result;
  					dataLocalFile = dataLocalFile.split("\n");
  					var lengthColumn = dataLocalFile[0].split(",").length;
  					drawCheckBox(lengthColumn);
  					//parseOutliers(outLiers,dataLocalFile);
				};

				function handleFileSelect(evt) {

					$('#box_drop_zone').toggleClass('box_drop_zone_start_drag');
    				evt.stopPropagation();
    				evt.preventDefault();

    				var files = evt.dataTransfer.files; // FileList object.

    				// files is a FileList of File objects. List some properties.
    				var output = [];
    				for (var i = 0, f; f = files[i]; i++) {
                  		pathFile = escape(f.name);
                  		file = f;
    				}

    				
  				}

				function handleDragOver(evt) {
					$('#box_drop_zone').toggleClass('box_drop_zone_start_drag');
				    evt.stopPropagation();
				    evt.preventDefault();
				    evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
				}

				// Setup the dnd listeners.
				var dropZone = document.getElementById('drop_zone');
				dropZone.addEventListener('dragover', handleDragOver, false);
				dropZone.addEventListener('drop', handleFileSelect, false);

				$( "#slider" ).slider({
    				change: function( event, ui ) {
    					console.log($( "#slider" ).slider( "value" ));
    				}
				});

				$( "#slider" ).on( "slidechange", function( event, ui ) {
					var sliderValue = $( "#slider" ).slider( "value" );
					sliderValue = (sliderValue / 100000) + 0.00001;
					$.get('http://localhost:8000/compute?file='+pathFile+'&threshold='+sliderValue, function(data,status) {
							if(status == "success"){
								oFReader.readAsText(file);
 								outLiers = data;
 								//parseOutliers(data);
							}
						});

				} );

				function parseOutliers(datos){
					$('.charts').remove();
					$('#tabla_outliers').remove();
					$('#box_tabla_outliers').append('<ul id="tabla_outliers"></ul>');
					var datosJSON = jQuery.parseJSON(datos);
					var lista = datosJSON.Lists;
					var listaDatos = [];
					for(var i=0;i<lista.length;i++){
						var arrayDatos = lista[i].split(" ");
						var setDatos = [];
						var x = arrayDatos[0];
						var y = arrayDatos[1];
						setDatos.push(parseInt(x));
						setDatos.push(parseInt(y));
						listaDatos.push(setDatos);
						$('#tabla_outliers').append('<li class="data_row_x"><label class="data data_x">'+x+'</label><label class="data data_y">'+y+'</label><li>');	
					}
					plotData(listaDatos,'container');			
				};

				
				function drawCheckBox(lengthColumn){
					$('#select_column').remove('.check_column');
					for(var i = 0; i<lengthColumn;i++){
						$('#select_column').append('<input id="check'+i+'" type="checkbox" class="check_column" value="Column'+i+'"">');
						$('#check'+i).click(function () {
							if(listaColumna.length < 2){
								listaColumna.push(parseInt(this.id.replace('check','')));
								if(listaColumna.length==2){
									var listaDatos = [];
									for(var j=0;j<dataLocalFile.length;j++){
										var auxData = dataLocalFile[j].split(',');
										var setDatos = [];
										var x = auxData[listaColumna[0]];
										var y = auxData[listaColumna[1]];
										setDatos.push(parseInt(x));
										setDatos.push(parseInt(y));
										listaDatos.push(setDatos);		
									}
									plotData(listaDatos,'contenedor');	
								}
							}else{
								listaColumna = [];
							}

						});
					}
				};

				

				function plotData(listaDatos,listaOutliers,divChar){
					$('#chart_container').append('<div id="'+divChar+'" class="charts" style="width: 100%; height: 400px"></div>');
					chart = new Highcharts.Chart({
            		chart: {
                		renderTo: divChar,
                		type: 'scatter',
                		zoomType: 'xy'
            		},
            		title: {
                		text: ''
            		},
            		subtitle: {
                		text: ''
            		},
		            xAxis: {
		                title: {
		                    enabled: true,
		                    text: 'Column X'
		                },
		                startOnTick: true,
		                endOnTick: true,
		                showLastLabel: true
		            },
			        yAxis: {
			            title: {
			                text: 'Column Y'
			                }
			            },
			        tooltip: {
			            formatter: function() {
			        	        return ''+
			                    this.x +' cm, '+ this.y +' kg';
			            }
			        },
		            legend: {
		                layout: 'vertical',
		                align: 'left',
		                verticalAlign: 'top',
		                x: 100,
		                y: 70,
		                floating: true,
		                backgroundColor: '#FFFFFF',
		                borderWidth: 1
		            },
		            plotOptions: {
		                scatter: {
		                    marker: {
		                        radius: 5,
		                        states: {
		                            hover: {
		                                enabled: true,
		                                lineColor: 'rgb(100,100,100)'
		                            }
		                        }
		                    },
		                    states: {
		                        hover: {
		                            marker: {
		                                enabled: false
		                            }
		                        }
		                    }
		                }
		            },
				    series: [{
				            name: '',
				            color: 'rgba(223, 83, 83, .5)',
				            data: listaDatos
				            }]
				        });
					};

			});

        
    

		</script>
	</head>
	<body>
		<div id="contenedor_principal">
			<div id="contenedor_cuerpo">
				<div id="box_drop_zone">	
					<div id="drop_zone">
						<div id="drop_zone_text">
							Drop your file here
						</div>	
					</div>
				</div>

				<div id="box_seek_bar">
					<div id="slider"></div>
				</div> 
				<div id="select_column">
					<a href="javascript:void(0)" onclick="plotear()">Plot</a>
				</div>
				<div id="chart_container">
				</div>	
				<div id="box_tabla_outliers">
					<div id="data_column_x" class="data_column">Column X</div>
					<div id="data_column_y" class="data_column">Column Y</div>
				</div>
			</div>	
		</div>	
	</body>	
</html> 